#!/bin/bash
# omarchy-launch-webapp funcional

if [[ -z "$1" ]]; then
    echo "Usage: omarchy-launch-webapp <url> [browser]"
    echo "Example: omarchy-launch-webapp https://claude.ai brave"
    exit 1
fi

URL="$1"
BROWSER="${2:-firefox}"

# Extraer dominio para perfil
DOMAIN=$(echo "$URL" | sed -E 's|^https?://([^/]+).*|\1|' | tr -cd '[:alnum:]_-')

# Usar xdg-open (más simple y funciona)
if command -v xdg-open &>/dev/null; then
    xdg-open "$URL" &
    echo "✅ Abriendo $URL"
    exit 0
fi

# Firefox con perfil separado
if [[ "$BROWSER" == "firefox" ]] && command -v firefox &>/dev/null; then
    # Crear perfil si no existe
    if ! find ~/.mozilla/firefox -name "*.$DOMAIN*" 2>/dev/null | grep -q .; then
        firefox -CreateProfile "$DOMAIN $HOME/.mozilla/firefox/$DOMAIN" 2>/dev/null
    fi
    firefox -P "$DOMAIN" --new-window "$URL" &
    
# Chromium/Chrome con --app
elif [[ "$BROWSER" =~ chrome|chromium|brave|edge ]] && command -v "$BROWSER" &>/dev/null; then
    "$BROWSER" --app="$URL" &
    
# Navegador genérico
elif command -v "$BROWSER" &>/dev/null; then
    "$BROWSER" "$URL" &
    
# Fallback: usar el navegador por defecto del sistema
else
    if command -v xdg-settings &>/dev/null; then
        DEFAULT_BROWSER=$(xdg-settings get default-web-browser | sed 's/\.desktop$//')
        "$DEFAULT_BROWSER" "$URL" &
    else
        echo "❌ No se pudo abrir el navegador"
        exit 1
    fi
fi

echo "✅ Abriendo $URL en $BROWSER"
exit 0
