#!/bin/bash

check_deps() {
    for cmd in gum curl; do
        if ! command -v "$cmd" &>/dev/null; then
            echo "âŒ Error: $cmd no estÃ¡ instalado"
            return 1
        fi
    done
    return 0
}

create_webapp() {
    local APP_NAME="$1"
    local APP_URL="$2"
    local ICON_REF="$3"
    local BROWSER="${4:-brave}"  # Brave por defecto
    
    echo "ğŸ”„ Creando webapp: $APP_NAME"
    
    # Validar
    [[ -z "$APP_NAME" || -z "$APP_URL" ]] && { echo "âŒ Error: Se necesitan nombre y URL"; exit 1; }
    
    # Directorio de iconos
    ICON_DIR="$HOME/.local/share/icons"
    mkdir -p "$ICON_DIR"
    
    # Icono
    ICON_PATH=""
    if [[ -n "$ICON_REF" ]] && [[ "$ICON_REF" =~ ^https?:// ]]; then
        ICON_FILE="$ICON_DIR/${APP_NAME// /_}.png"
        echo "ğŸ“¥ Descargando icono..."
        if curl -sL -o "$ICON_FILE" "$ICON_REF"; then
            ICON_PATH="$ICON_FILE"
            echo "âœ… Icono descargado"
        else
            ICON_PATH="web-browser"
            echo "âš ï¸  Usando icono por defecto"
        fi
    else
        ICON_PATH="web-browser"
    fi
    
    # COMANDO EXEC CORREGIDO - Â¡ESTO ES LA CLAVE!
    # Para navegadores Chromium: usar --app para modo aplicaciÃ³n
    # Para Firefox: usar --new-window para ventana dedicada
    
    local EXEC_COMMAND=""
    
    case "$BROWSER" in
        brave|chrome|chromium|edge|vivaldi|opera)
            # Modo aplicaciÃ³n REAL (sin UI de navegador)
            EXEC_COMMAND="$BROWSER --app=\"$APP_URL\""
            ;;
        firefox)
            # Firefox no tiene --app, pero podemos usar ventana dedicada
            # Extraer dominio para perfil Ãºnico
            DOMAIN=$(echo "$APP_URL" | sed -E 's|^https?://([^/]+).*|\1|' | tr -cd '[:alnum:]')
            EXEC_COMMAND="sh -c 'if ! pgrep -f \"firefox.*-P.*$DOMAIN\" >/dev/null; then firefox -CreateProfile \"$DOMAIN\" 2>/dev/null; fi; firefox -P \"$DOMAIN\" --new-window \"$APP_URL\"'"
            ;;
        *)
            # Fallback: xdg-open
            EXEC_COMMAND="sh -c 'xdg-open \"$APP_URL\"'"
            ;;
    esac
    
    # Crear archivo .desktop
    DESKTOP_FILE="$HOME/.local/share/applications/${APP_NAME// /_}.desktop"
    
    cat >"$DESKTOP_FILE" <<DESKTOP_ENTRY
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=Open $APP_NAME
Exec=$EXEC_COMMAND
Terminal=false
Type=Application
Icon=$ICON_PATH
Categories=Network;
StartupNotify=true
StartupWMClass=${APP_NAME// /_}
DESKTOP_ENTRY
    
    chmod +x "$DESKTOP_FILE"
    
    echo "âœ… Webapp creada: $DESKTOP_FILE"
    echo "ğŸ¯ Ejecuta desde tu menÃº o con:"
    echo "   $BROWSER --app=\"$APP_URL\""
    
    # Actualizar base de datos
    command -v update-desktop-database &>/dev/null && \
        update-desktop-database ~/.local/share/applications
}

# Modo interactivo mejorado
interactive_mode() {
    echo -e "\n\e[36mâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\e[0m"
    echo -e "\e[36mâ”‚         ğŸ“± CREAR WEBAPP COMO APLICACIÃ“N        â”‚\e[0m"
    echo -e "\e[36mâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\e[0m\n"
    
    echo "Esto crearÃ¡ una aplicaciÃ³n NATIVA para un sitio web,"
    echo "con su propio icono en el menÃº y ventana dedicada.\n"
    
    # Nombre
    APP_NAME=$(gum input --prompt "ğŸ“ Nombre de la aplicaciÃ³n: " --placeholder "Ej: Claude AI, WhatsApp Web" --value "")
    [[ -z "$APP_NAME" ]] && { echo "âŒ Nombre requerido"; exit 1; }
    
    # URL
    APP_URL=$(gum input --prompt "ğŸŒ URL del sitio: " --placeholder "https://ejemplo.com" --value "")
    [[ -z "$APP_URL" ]] && { echo "âŒ URL requerida"; exit 1; }
    
    # Navegador
    echo -e "\nğŸŒ Â¿En quÃ© navegador quieres abrirlo?"
    echo "   (Brave/Chrome abren como APLICACIÃ“N, Firefox como ventana dedicada)"
    BROWSER=$(gum choose \
        "brave  (recomendado - modo aplicaciÃ³n)" \
        "chrome (modo aplicaciÃ³n)" \
        "firefox (ventana dedicada)" \
        "chromium (modo aplicaciÃ³n)" \
        --header "Selecciona navegador" | cut -d' ' -f1)
    
    # Icono
    echo -e "\nğŸ¨ Â¿Quieres un icono personalizado?"
    echo "1. SÃ­, descargar de una URL"
    echo "2. No, usar icono por defecto"
    
    ICON_CHOICE=$(gum choose "1" "2" --header "OpciÃ³n de icono")
    
    ICON_REF=""
    if [[ "$ICON_CHOICE" == "1" ]]; then
        ICON_REF=$(gum input --prompt "ğŸ“ URL del icono (PNG): " \
            --placeholder "https://.../icono.png" \
            --value "https://cdn.prod.website-files.com/5f5e5237a5a0f9f3c7a3c8c2/6419c0e5e7e3e74af5b8f3d5_favicon-large.png")
    fi
    
    # Confirmar
    echo -e "\nğŸ“‹ Resumen:"
    echo "   Nombre: $APP_NAME"
    echo "   URL: $APP_URL"
    echo "   Navegador: $BROWSER"
    [[ -n "$ICON_REF" ]] && echo "   Icono: Personalizado" || echo "   Icono: Por defecto"
    
    gum confirm "Â¿Crear aplicaciÃ³n?" || exit 0
    
    create_webapp "$APP_NAME" "$APP_URL" "$ICON_REF" "$BROWSER"
}

main() {
    check_deps || exit 1
    
    if [[ "$#" -lt 2 ]]; then
        interactive_mode
    else
        create_webapp "$@"
    fi
}

main "$@"
