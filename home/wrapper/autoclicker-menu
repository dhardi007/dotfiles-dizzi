#!/bin/bash
# autoclicker-menu (ULTRA-FIXED v2)
# Wrapper que LIMPIA el estado antes de mostrar el menÃº

# Configurar socket de ydotool
export YDOTOOL_SOCKET=/tmp/.ydotool_socket

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LIMPIAR ESTADO ANTES DE MOSTRAR MENÃš
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PIDFILE="/tmp/ydotool-autoclicker.pid"

# FunciÃ³n para limpiar PIDs zombies
clean_zombie_pids() {
  if [[ -f "$PIDFILE" ]]; then
    local pid=$(cat "$PIDFILE")
    
    # Verificar si el proceso realmente existe
    if ! kill -0 "$pid" 2>/dev/null; then
      # PID muerto â†’ limpiar
      rm -f "$PIDFILE"
      echo "ğŸ§¹ Limpiando PID zombie ($pid)"
      return 1
    fi
    
    # PID vivo â†’ mostrar estado
    echo "âš ï¸  AutoClicker detectado corriendo (PID: $pid)"
    echo "   Detenlo primero con F8 o:"
    echo "   ~/.local/bin/autoclicker stop"
    echo
    read -p "Â¿Detener ahora y continuar? [S/n]: " confirm
    
    if [[ ! "$confirm" =~ ^[Nn]$ ]]; then
      # Matar el proceso
      pkill -P "$pid" 2>/dev/null
      kill -TERM "$pid" 2>/dev/null
      sleep 0.2
      kill -9 "$pid" 2>/dev/null
      rm -f "$PIDFILE"
      echo "âœ… AutoClicker detenido"
      sleep 1
    else
      exit 0
    fi
  fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VERIFICAR YDOTOOL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ! systemctl --user is-active --quiet ydotool.service; then
  echo -e "\033[1;31mâŒ Error: ydotool no estÃ¡ corriendo\033[0m"
  echo
  echo -e "\033[0;33mIniciando ydotool...\033[0m"
  systemctl --user start ydotool.service
  sleep 2
fi

if [[ ! -S /tmp/.ydotool_socket ]]; then
  echo -e "\033[1;31mâŒ Error: Socket no encontrado\033[0m"
  echo -e "\033[0;33mEjecuta: bash ~/fix-ydotool.sh\033[0m"
  echo
  echo -e "\033[0;36mPresiona Enter para cerrar...\033[0m"
  read -r
  exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LIMPIAR ESTADO Y EJECUTAR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
clean_zombie_pids

# Ejecutar autoclicker con menÃº interactivo
~/.local/bin/autoclicker menu

# Esperar Enter para cerrar (solo si terminÃ³ normalmente)
echo
echo -e "\033[1;33mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
echo -e "\033[1;32mâœ… Proceso completado\033[0m"
echo -e "\033[0;36mPresiona Enter para cerrar...\033[0m"
read -r
