#!/bin/bash
#######################################################################################
# Configs DIZZI - Wallpaper Selector con Animaciones Aleatorias
#######################################################################################

# Directorio de wallpapers
WALL_DIR="$HOME/wallpapers/wallpapers/"
cd "$WALL_DIR" || exit

# SelecciÃ³n desde Rofi con previews
SELECTED_WALL=$(for a in *.jpg *.png *.webp *.gif; do
  echo -en "$a\0icon\x1f$a\n"
done | rofi -dmenu -p "ó°¸‰ " -theme ~/.config/rofi/config-wallpaper.rasi)

if [ -n "$SELECTED_WALL" ]; then
  notify-send "ðŸŽ¨ Changing Theme" "Applying new wallpaper with epic transition..."

  # ðŸŽ­ Array de 6 animaciones increÃ­bles
  transitions=(
    # 1ï¸âƒ£ Ola Ã©pica desde cualquier direcciÃ³n
    "wave --transition-angle 45 --transition-fps 60 --transition-step 90 --transition-wave 30,20"

    # 2ï¸âƒ£ Crecimiento explosivo desde el centro
    "grow --transition-pos 0.5,0.5 --transition-fps 60 --transition-step 90"

    # 3ï¸âƒ£ Barrido circular impactante
    "wipe --transition-angle $(shuf -i 0-360 -n 1) --transition-fps 60 --transition-step 120"

    # 4ï¸âƒ£ Zoom desde esquina aleatoria
    "outer --transition-pos $(shuf -e "0.0,0.0" "1.0,0.0" "0.0,1.0" "1.0,1.0" -n 1) --transition-fps 60 --transition-step 100"

    # 5ï¸âƒ£ MÃºltiples ondas entrelazadas
    "wave --transition-angle $(shuf -i 0-360 -n 1) --transition-fps 60 --transition-step 120 --transition-wave 50,30"

    # 6ï¸âƒ£ Centro clÃ¡sico suave (animaciÃ³n original)
    "center --transition-fps 30 --transition-step 2"
  )

  # ðŸŽ² Seleccionar animaciÃ³n aleatoria
  RANDOM_TRANSITION=${transitions[$RANDOM % ${#transitions[@]}]}

  # ðŸ”§ FunciÃ³n para detectar el compositor
detect_compositor() {
  if command -v niri >/dev/null 2>&1 && pgrep -x niri >/dev/null; then
    echo "niri"
  elif command -v hyprctl >/dev/null 2>&1 && pgrep -x Hyprland >/dev/null; then
    echo "hyprland"
  else
    echo "unknown"
  fi
}

# ðŸ”§ FunciÃ³n para activar modo noche
toggle-wallpaper() {
  local compositor=$(detect_compositor)

  case "$compositor" in
  "hyprland")
    # ðŸŒŠ Cambiar el fondo con swww y animaciÃ³n Ã©pica
    swww img "$WALL_DIR/$SELECTED_WALL" --transition-type $RANDOM_TRANSITION
    ;;
  "niri")
    swaybg -i "$WALL_DIR/$SELECTED_WALL" -m fill
    ;;
  *)
    echo "âŒ Compositor no soportado"
    return 1
    ;;
  esac

  # Generar paleta de colores con Pywal (silencioso)
  wal -q -i "$WALL_DIR/$SELECTED_WALL"

  # Recargar Waybar de manera eficiente
  if pgrep -x waybar >/dev/null; then
    pkill -RTMIN+1 waybar
  else
    waybar -c ~/.config/waybar/config &
  fi

  # Recargar Eww solo si estÃ¡ corriendo
  if pgrep -x eww >/dev/null; then
    eww reload
  fi

  hyprctl reload
  swaync-client -rs

  notify-send "âœ… Wallpaper aplicado" "Con animaciÃ³n Ã©pica ðŸ”¥"
fi
